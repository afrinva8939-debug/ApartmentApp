<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Apartment Explorer</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
        .card-hover { transition: transform .18s ease, box-shadow .18s ease; }
        .card-hover:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.12); }
        .price { font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
<header class="bg-gradient-to-r from-indigo-600 to-cyan-500 text-white p-6 shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <h1 class="text-2xl font-semibold">Apartment Explorer</h1>
        <div class="flex items-center gap-3">
            <input id="search" placeholder="Search by name or address..." class="px-3 py-2 rounded-md w-80 text-slate-800" />
            <button id="refresh" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-md">Refresh</button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6">
    <section class="mb-6 flex items-center justify-between gap-4">
        <div class="flex gap-3">
            <select id="sort" class="px-3 py-2 rounded-md">
                <option value="agg_datetime:desc">Newest</option>
                <option value="minRent:asc">Lowest rent</option>
                <option value="minRent:desc">Highest rent</option>
            </select>
            <input id="beds" placeholder="Beds (e.g. 2)" class="px-3 py-2 rounded-md w-28" />
        </div>
        <div class="text-sm text-slate-500">Showing <span id="count">0</span> apartments</div>
    </section>

    <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- cards -->
    </section>

    <nav class="mt-8 flex items-center justify-center gap-3">
        <button id="prev" class="px-3 py-2 rounded-md bg-white">Prev</button>
        <span id="pageInfo" class="px-3"></span>
        <button id="next" class="px-3 py-2 rounded-md bg-white">Next</button>
    </nav>
</main>

<div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white max-w-2xl w-full rounded-xl p-6">
        <button id="closeModal" class="float-right">Close</button>
        <div id="modalContent"></div>
    </div>
</div>

<script>
    const API_BASE = '/api/apartments';
    let page = 0, size = 9, totalPages = 0;

    const el = id => document.getElementById(id);

    async function fetchApartments() {
      const q = el('search').value.trim();
      const sortVal = el('sort').value.split(':');
      const sortBy = sortVal[0] || 'agg_datetime';
      const order = sortVal[1] || 'desc';

      const url = new URL(API_BASE, location.origin);
      url.searchParams.set('page', page);
      url.searchParams.set('size', size);
      url.searchParams.set('sortBy', sortBy);
      url.searchParams.set('order', order);
      url.searchParams.set('q', q);

      const res = await fetch(url);
      if(!res.ok) {
        console.error('api error', await res.text());
        return;
      }
      const data = await res.json();
      renderGrid(data);
    }

    function parseRent(rentStr) {
      if(!rentStr) return null;
      const clean = rentStr.replace(/[^\d]/g,'');
      return clean ? parseInt(clean, 10) : null;
    }

    function renderGrid(pageData) {
      const grid = el('grid');
      grid.innerHTML = '';
      el('count').textContent = pageData.totalElements ?? 0;
      totalPages = pageData.totalPages ?? 0;
      el('pageInfo').textContent = `Page ${page+1} of ${Math.max(totalPages,1)}`;

      (pageData.content || []).forEach(a => {
        const minRent = parseRent(a.minRent) ?? '-';
        const maxRent = parseRent(a.maxRent) ?? '-';
        const card = document.createElement('article');
        card.className = 'bg-white rounded-xl p-4 card-hover';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-semibold">${escapeHtml(a.apartmentName || 'Unnamed')}</h3>
              <p class="text-sm text-slate-500">${escapeHtml(a.address || '')}</p>
              <div class="mt-3 text-sm text-slate-600">Beds: ${escapeHtml(a.bed||'N/A')} · Baths: ${escapeHtml(a.bath||'N/A')}</div>
            </div>
            <div class="text-right">
              <div class="price text-xl text-slate-800">₹ ${minRent !== '-' ? minRent.toLocaleString() : '-'}</div>
              <div class="text-xs text-slate-500">from</div>
              <button class="mt-3 openBtn text-sm px-3 py-1 rounded-md border">View</button>
            </div>
          </div>
        `;
        const btn = card.querySelector('.openBtn');
        btn.addEventListener('click', () => openModal(a.id));
        grid.appendChild(card);
      });
    }

    async function openModal(id) {
      const res = await fetch(`${API_BASE}/${id}`);
      if(!res.ok) {
        alert('Failed to load details');
        return;
      }
      const a = await res.json();
      el('modalContent').innerHTML = `
        <h2 class="text-2xl font-semibold mb-2">${escapeHtml(a.apartmentName || '')}</h2>
        <p class="text-sm text-slate-600 mb-3">${escapeHtml(a.address || '')}</p>
        <dl class="grid grid-cols-2 gap-3 text-sm">
          <div><dt class="font-medium">Rent</dt><dd>₹ ${a.minRent || 'N/A'} - ${a.maxRent || 'N/A'}</dd></div>
          <div><dt class="font-medium">Beds</dt><dd>${a.bed || 'N/A'}</dd></div>
          <div><dt class="font-medium">Baths</dt><dd>${a.bath || 'N/A'}</dd></div>
          <div><dt class="font-medium">Sqft</dt><dd>${a.sqft || 'N/A'}</dd></div>
          <div><dt class="font-medium">Available</dt><dd>${a.availableDateFormatted || 'N/A'}</dd></div>
          <div><dt class="font-medium">State</dt><dd>${a.state || 'N/A'}</dd></div>
        </dl>
        <div class="mt-4 text-right">
          <button id="closeModal2" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Close</button>
        </div>
      `;
      el('modal').classList.remove('hidden');
      el('closeModal2').addEventListener('click', closeModal);
    }

    function closeModal() {
      el('modal').classList.add('hidden');
      el('modalContent').innerHTML = '';
    }

    function escapeHtml(str) {
      if(!str) return '';
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    el('prev').addEventListener('click', ()=> { if(page>0){ page--; fetchApartments(); } });
    el('next').addEventListener('click', ()=> { if(page < totalPages-1){ page++; fetchApartments(); } });

    el('search').addEventListener('input', () => { page = 0; debounceFetch();});
    el('sort').addEventListener('change', () => { page = 0; fetchApartments();});
    el('refresh').addEventListener('click', ()=> fetchApartments());
    el('modal').addEventListener('click', (e)=> { if(e.target === el('modal')) closeModal() });
    el('closeModal').addEventListener('click', closeModal);

    let debounceTimer = null;
    function debounceFetch(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(() => fetchApartments(), 350); }

    fetchApartments();
</script>
</body>
</html>
